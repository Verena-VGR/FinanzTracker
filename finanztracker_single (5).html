<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanzTracker - Vollständiger Export</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        #formContainer.hidden { display: none; }
        #formContainer { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .transaction-item { transition: all 0.2s ease; }
        .transaction-item:hover { transform: translateX(4px); }
        .transaction-item .delete-btn { opacity: 0.7; transition: all 0.2s ease; }
        .transaction-item:hover .delete-btn { opacity: 1; color: #f43f5e; }
        input[type="checkbox"]:checked { background-color: #10b981; border-color: #10b981; }
    </style>
</head>
<body class="bg-[#f5f5f5] text-slate-900 pb-12 antialiased">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-2xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-sm">
                    <i data-lucide="trending-up"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">FinanzTracker</h1>
            </div>
            <button id="toggleFormBtn" class="p-2 bg-slate-900 text-white rounded-full hover:bg-slate-800 transition-colors shadow-md">
                <span id="toggleIcon"><i data-lucide="plus-circle"></i></span>
            </button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 mt-6 space-y-6">
        <div id="formContainer" class="hidden">
            <form id="transactionForm" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Datum</label>
                        <input type="date" id="date" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Typ</label>
                        <select id="type" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="Ausgabe">Ausgabe</option>
                            <option value="Einnahme">Einnahme</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Kategorie</label>
                        <select id="category" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Betrag (€)</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Beschreibung</label>
                    <div class="flex gap-4 items-center">
                        <input type="text" id="description" placeholder="z.B. Miete" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                        <label class="flex items-center gap-2 cursor-pointer select-none shrink-0">
                            <input type="checkbox" id="isFixed" class="w-5 h-5 rounded border-slate-300 text-emerald-500">
                            <span class="text-sm font-medium text-slate-600">Fixkosten?</span>
                        </label>
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition-colors shadow-lg">Eintrag speichern</button>
            </form>
        </div>

        <div class="flex gap-3 items-center overflow-x-auto pb-2 scrollbar-hide">
            <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-slate-200 shadow-sm shrink-0">
                <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                <select id="filterMonth" class="bg-transparent outline-none text-sm font-medium"></select>
            </div>
            <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-slate-200 shadow-sm shrink-0">
                <i data-lucide="filter" class="w-4 h-4 text-slate-400"></i>
                <select id="filterYear" class="bg-transparent outline-none text-sm font-medium"></select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Einnahmen</p>
                <p id="statIncome" class="text-2xl font-bold text-emerald-600">+0.00 €</p>
            </div>
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Ausgaben</p>
                <p id="statExpenses" class="text-2xl font-bold text-rose-500">-0.00 €</p>
            </div>
            <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 shadow-sm">
                <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">Sparen</p>
                <p id="statSavings" class="text-2xl font-bold text-indigo-600">0.00 €</p>
            </div>
            <div id="balanceCard" class="p-5 rounded-2xl border shadow-sm">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Differenz</p>
                <p id="statBalance" class="text-2xl font-bold">+0.00 €</p>
            </div>
        </div>

        <div id="chartSection" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hidden">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="pie-chart" class="w-5 h-5 text-slate-400"></i>
                <h2 class="font-bold text-slate-800">Gesamtübersicht</h2>
            </div>
            <div class="h-[300px] w-full relative">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="wallet" class="w-5 h-5 text-slate-400"></i>
                <h2 class="font-bold text-slate-800">Einnahmen nach Kategorie</h2>
            </div>
            <div id="incomeBreakdown" class="space-y-3"></div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="pie-chart" class="w-5 h-5 text-slate-400"></i>
                <h2 class="font-bold text-slate-800">Ausgaben nach Kategorie</h2>
            </div>
            <div id="expenseBreakdown" class="space-y-3"></div>
        </div>

        <div class="space-y-4">
            <h2 class="font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="euro" class="w-5 h-5 text-slate-400"></i>
                Transaktionen
            </h2>
            <div id="transactionList" class="space-y-3"></div>
        </div>
    </main>

    <script>
        const CATEGORIES = ['Miete', 'Strom / Gas', 'Internet - Handy', 'Versicherungen', 'Mobilität - Auto', 'Lebensmittel', 'Drogerie & Beauty', 'Shopping', 'Freizeit', 'Gastronomie', 'Sonstiges', 'Sparen'];
        const INCOME_CATEGORIES = ['Gehalt', 'Geschenke'];
        const EXPENSE_COLORS = ['#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#06b6d4', '#64748b', '#94a3b8'];
        const INCOME_COLORS = ['#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];

        let transactions = JSON.parse(localStorage.getItem('finanz_transactions')) || [];
        let filterMonth = new Date().getMonth() + 1;
        let filterYear = new Date().getFullYear();
        let mainChart = null;

        function generateId() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID) 
                ? crypto.randomUUID() 
                : Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function deleteTransaction(id) {
            console.log('Attempting to delete transaction with ID:', id);
            const initialCount = transactions.length;
            transactions = transactions.filter(t => t.id !== id);
            console.log('Transactions after deletion:', transactions.length);
            if (initialCount === transactions.length) {
                console.warn('No transaction found with ID:', id);
            }
            render();
        }
        window.deleteTransaction = deleteTransaction;

        function init() {
            const dateInput = document.getElementById('date');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            updateCategoryOptions();
            populateFilters();
            render();
            lucide.createIcons();
        }

        function updateCategoryOptions() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '';
            const cats = type === 'Einnahme' ? INCOME_CATEGORIES : CATEGORIES;
            cats.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function populateFilters() {
            const mSelect = document.getElementById('filterMonth');
            mSelect.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = new Date(2000, i - 1).toLocaleString('de-DE', { month: 'long' });
                if (i == filterMonth) opt.selected = true;
                mSelect.appendChild(opt);
            }
            const years = [...new Set([new Date().getFullYear(), ...transactions.map(t => t.year)])].sort((a, b) => b - a);
            const ySelect = document.getElementById('filterYear');
            ySelect.innerHTML = '';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y == filterYear) opt.selected = true;
                ySelect.appendChild(opt);
            });
        }

        function render() {
            const filtered = transactions.filter(t => t.month == filterMonth && t.year == filterYear).sort((a, b) => new Date(b.date) - new Date(a.date));
            const income = filtered.filter(t => t.type === 'Einnahme').reduce((s, t) => s + t.amount, 0);
            const expenses = filtered.filter(t => t.type === 'Ausgabe').reduce((s, t) => s + t.amount, 0);
            const savings = filtered.filter(t => t.category === 'Sparen').reduce((s, t) => s + t.amount, 0);
            const realExp = expenses - savings;
            const balance = income - expenses;

            document.getElementById('statIncome').textContent = `+${income.toFixed(2)} €`;
            document.getElementById('statExpenses').textContent = `-${realExp.toFixed(2)} €`;
            document.getElementById('statSavings').textContent = `${savings.toFixed(2)} €`;
            document.getElementById('statBalance').textContent = `${balance >= 0 ? '+' : ''}${balance.toFixed(2)} €`;
            
            const bCard = document.getElementById('balanceCard');
            const bText = document.getElementById('statBalance');
            if (balance >= 0) {
                bCard.className = 'p-5 rounded-2xl border shadow-sm bg-emerald-50 border-emerald-100';
                bText.className = 'text-2xl font-bold text-emerald-700';
            } else {
                bCard.className = 'p-5 rounded-2xl border shadow-sm bg-rose-50 border-rose-100';
                bText.className = 'text-2xl font-bold text-rose-700';
            }

            renderBreakdown('incomeBreakdown', INCOME_CATEGORIES, filtered, income, 'Einnahme');
            renderBreakdown('expenseBreakdown', CATEGORIES, filtered, expenses, 'Ausgabe');
            renderList(filtered);
            updateChart(filtered);
            localStorage.setItem('finanz_transactions', JSON.stringify(transactions));
            lucide.createIcons();
        }

        function renderBreakdown(id, cats, filtered, total, type) {
            const container = document.getElementById(id);
            container.innerHTML = '';
            const totals = {};
            cats.forEach(c => totals[c] = filtered.filter(t => t.category === c).reduce((s, t) => s + t.amount, 0));
            const active = cats.filter(c => totals[c] > 0);
            if (active.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-400 italic">Keine Einträge</p>';
                return;
            }
            active.forEach(c => {
                const amt = totals[c];
                const pct = total > 0 ? (amt / total) * 100 : 0;
                const isS = c === 'Sparen';
                container.insertAdjacentHTML('beforeend', `
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span class="font-medium ${isS ? 'text-indigo-600 font-bold' : 'text-slate-600'}">${c}</span>
                            <span class="font-bold ${type === 'Einnahme' ? 'text-emerald-600' : (isS ? 'text-indigo-700' : 'text-slate-900')}">${type === 'Einnahme' ? '+' : '-'}${amt.toFixed(2)} €</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full rounded-full ${type === 'Einnahme' ? 'bg-emerald-500' : (isS ? 'bg-indigo-500' : 'bg-slate-400')}" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `);
            });
        }

        function renderList(filtered) {
            const list = document.getElementById('transactionList');
            list.innerHTML = filtered.length === 0 ? '<div class="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300"><p class="text-slate-400 font-medium">Keine Einträge</p></div>' : '';
            filtered.forEach(t => {
                const isS = t.category === 'Sparen';
                list.insertAdjacentHTML('beforeend', `
                    <div class="transaction-item p-4 rounded-2xl border shadow-sm flex justify-between items-center group ${isS ? 'bg-indigo-50/50 border-indigo-100' : 'bg-white border-slate-200'}">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${t.type === 'Einnahme' ? 'bg-emerald-100 text-emerald-600' : (isS ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-600')}">
                                <i data-lucide="${t.type === 'Einnahme' ? 'trending-up' : 'trending-down'}"></i>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-bold ${isS ? 'text-indigo-900' : 'text-slate-900'}">${t.description || t.category}</p>
                                    ${t.isFixed ? '<span class="px-1.5 py-0.5 bg-slate-100 text-slate-500 text-[10px] font-bold uppercase tracking-wider rounded border border-slate-200">Fix</span>' : ''}
                                </div>
                                <div class="flex items-center gap-2 text-xs text-slate-400 font-medium">
                                    <span>${new Date(t.date).toLocaleDateString('de-DE')}</span> • <span>${t.category}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-bold text-lg ${t.type === 'Einnahme' ? 'text-emerald-600' : (isS ? 'text-indigo-600' : 'text-slate-900')}">${t.type === 'Einnahme' ? '+' : '-'}${t.amount.toFixed(2)} €</p>
                            <button onclick="deleteTransaction('${t.id}')" class="delete-btn p-2 text-slate-400 hover:text-rose-500">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
        }

        function updateChart(filtered) {
            const data = []; const colors = [];
            INCOME_CATEGORIES.forEach((c, i) => {
                const v = filtered.filter(t => t.category === c).reduce((s, t) => s + t.amount, 0);
                if (v > 0) { data.push({ n: c, v, t: 'Einnahme' }); colors.push(INCOME_COLORS[i % INCOME_COLORS.length]); }
            });
            CATEGORIES.forEach((c, i) => {
                const v = filtered.filter(t => t.category === c).reduce((s, t) => s + t.amount, 0);
                if (v > 0) { data.push({ n: c, v, t: 'Ausgabe' }); colors.push(EXPENSE_COLORS[i % EXPENSE_COLORS.length]); }
            });
            const section = document.getElementById('chartSection');
            if (data.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: data.map(d => `${d.n} (${d.t})`), datasets: [{ data: data.map(d => d.v), backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10 } } } }, cutout: '70%' }
            });
        }

        function updateToggleIcon(isHidden) {
            const iconContainer = document.getElementById('toggleIcon');
            if (iconContainer) {
                iconContainer.innerHTML = isHidden ? '<i data-lucide="plus-circle"></i>' : '<i data-lucide="chevron-up"></i>';
                lucide.createIcons();
            }
        }

        document.getElementById('toggleFormBtn').onclick = () => {
            const c = document.getElementById('formContainer');
            c.classList.toggle('hidden');
            updateToggleIcon(c.classList.contains('hidden'));
        };
        document.getElementById('type').onchange = updateCategoryOptions;
        document.getElementById('filterMonth').onchange = (e) => { filterMonth = e.target.value; render(); };
        document.getElementById('filterYear').onchange = (e) => { filterYear = e.target.value; render(); };
        document.getElementById('transactionForm').onsubmit = (e) => {
            e.preventDefault();
            const dVal = document.getElementById('date').value;
            const dObj = new Date(dVal);
            const t = { id: generateId(), date: dVal, type: document.getElementById('type').value, category: document.getElementById('category').value, description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value), month: dObj.getMonth() + 1, year: dObj.getFullYear(), isFixed: document.getElementById('isFixed').checked };
            transactions.unshift(t);
            if (t.isFixed) {
                const nD = new Date(dObj); nD.setMonth(nD.getMonth() + 1);
                transactions.unshift({ ...t, id: generateId(), date: nD.toISOString().split('T')[0], month: nD.getMonth() + 1, year: nD.getFullYear() });
            }
            document.getElementById('transactionForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            updateCategoryOptions();
            document.getElementById('formContainer').classList.add('hidden');
            updateToggleIcon(true);
            populateFilters(); render();
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
